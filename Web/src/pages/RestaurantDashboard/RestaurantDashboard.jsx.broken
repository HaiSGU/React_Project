import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { getCurrentOwner, logoutOwner } from '@shared/services/restaurantAuthService'
import {
  getRestaurantStats,
  updateOrderStatus,
  getChartData,
  getOrdersByDateFilter
} from '@shared/services/ownerOrderService'
import {
  getRestaurantMenu,
  addMenuItem,
  updateMenuItem,
  deleteMenuItem,
  toggleMenuItemAvailability
} from '@shared/services/ownerMenuService'
import {
  getRestaurantVouchers,
  createVoucher,
  updateVoucher,
  deleteVoucher
} from '@shared/services/voucherService'
import { useRealtimeOrders, useNotifications, useEventListener } from '@shared/hooks/useRealtime'
import { notifyOrderConfirmed, notifyOrderShipping } from '@shared/services/notificationService'
import { syncSystemRevenue } from '@shared/services/dataSyncService'
import eventBus, { EVENT_TYPES } from '@shared/services/eventBus'
import { updateRestaurantStatus } from '@shared/services/adminMetricsService'
import NotificationBell from '../../components/NotificationBell/NotificationBell'
import OrderChart from '../../components/Dashboard/OrderChart'
import NotificationSystem from '../../components/Dashboard/NotificationSystem'
import OrderFilters from '../../components/Dashboard/OrderFilters'
import MenuItemModal from '../../components/Dashboard/MenuItemModal'
import VoucherModal from '../../components/Dashboard/VoucherModal'
import './RestaurantDashboard.css'

export default function RestaurantDashboard() {
  const [ownerInfo] = useState(() => getCurrentOwner(localStorage))
  const [stats, setStats] = useState(null)
  const [menuInfo, setMenuInfo] = useState(null)
  const [orders, setOrders] = useState([])
  const [chartData, setChartData] = useState([])
  const [vouchers, setVouchers] = useState([])
  const [activeTab, setActiveTab] = useState('overview')
  const [restaurantStatus, setRestaurantStatus] = useState('active') // active | suspended

  // ğŸ”¥ Real-time hooks
  const { orders: realtimeOrders, lastUpdate } = useRealtimeOrders()
  const { unreadCount } = useNotifications('restaurant')

  // Filters
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState('all')
  const [dateFilter, setDateFilter] = useState('today')

  // Modals
  const [isMenuModalOpen, setIsMenuModalOpen] = useState(false)
  const [isVoucherModalOpen, setIsVoucherModalOpen] = useState(false)
  const [editingMenuItem, setEditingMenuItem] = useState(null)
  const [editingVoucher, setEditingVoucher] = useState(null)

  const navigate = useNavigate()

  // ğŸ”¥ Listen to new orders

  if (result.success) {
    setRestaurantStatus(newStatus)
    eventBus.emit(EVENT_TYPES.RESTAURANT_STATUS_CHANGED, {
      restaurantId: ownerInfo.restaurantId,
      status: newStatus,
    })

    alert(newStatus === 'active'
      ? 'âœ… ÄÃ£ kÃ­ch hoáº¡t nhÃ  hÃ ng! KhÃ¡ch hÃ ng cÃ³ thá»ƒ Ä‘áº·t hÃ ng.'
      : 'â¸ï¸ ÄÃ£ táº¡m ngÆ°ng nhÃ  hÃ ng. KhÃ¡ch hÃ ng sáº½ khÃ´ng tháº¥y nhÃ  hÃ ng trong danh sÃ¡ch.')
  } else {
    alert(result.error || 'âš ï¸ KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i nhÃ  hÃ ng. Vui lÃ²ng thá»­ láº¡i.')
  }
}

const handleUpdateOrderStatus = async (orderId, newStatus) => {
  const result = await updateOrderStatus(orderId, newStatus, localStorage)
  if (result.success) {
    // ğŸ”” Gá»­i notification cho customer
    const order = orders.find(o => o.id === orderId)
    if (order) {
      if (newStatus === 'processing') {
        notifyOrderConfirmed(localStorage, order)
      } else if (newStatus === 'shipping') {
        notifyOrderShipping(localStorage, order)
      }
    }

    // ğŸ“Š Sync system revenue
    syncSystemRevenue(localStorage)

    loadDashboardData()
    alert(`âœ… ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng!`)
  } else {
    alert(result.error || 'âŒ Lá»—i cáº­p nháº­t tráº¡ng thÃ¡i!')
  }
}

const exportToCSV = () => {
  const headers = ['MÃ£ Ä‘Æ¡n', 'KhÃ¡ch hÃ ng', 'Äá»‹a chá»‰', 'Tá»•ng tiá»n', 'Tráº¡ng thÃ¡i', 'NgÃ y']

  const rows = filteredOrders.map(order => [
    order.id || 'N/A',
    order.customerName || 'KhÃ¡ch hÃ ng',
    order.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰',
    order.totalPrice || 0,
    order.status || 'pending',
    new Date(order.date || order.createdAt).toLocaleString('vi-VN')
  ])

  let csvContent = '\uFEFF' + headers.join(',') + '\n'
  rows.forEach(row => {
    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n'
  })

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = `orders_${ownerInfo.restaurantName}_${new Date().toISOString().split('T')[0]}.csv`
  link.click()
}

// MENU HANDLERS
const handleAddMenuItem = () => {
  setEditingMenuItem(null)
  setIsMenuModalOpen(true)
}

const handleEditMenuItem = (item) => {
  setEditingMenuItem(item)
  setIsMenuModalOpen(true)
}

const handleSaveMenuItem = (itemData) => {
  if (editingMenuItem) {
    // Sá»­a mÃ³n
    const result = updateMenuItem(ownerInfo.restaurantId, editingMenuItem.id, itemData, localStorage)
    if (result.success) {
      alert('âœ… Cáº­p nháº­t mÃ³n thÃ nh cÃ´ng!')
      setIsMenuModalOpen(false)
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  } else {
    // ThÃªm mÃ³n má»›i
    const result = addMenuItem(ownerInfo.restaurantId, itemData, localStorage)
    if (result.success) {
      alert('âœ… ThÃªm mÃ³n thÃ nh cÃ´ng!')
      setIsMenuModalOpen(false)
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  }
}

const handleDeleteMenuItem = (itemId, itemName) => {
  if (window.confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a mÃ³n "${itemName}"?`)) {
    const result = deleteMenuItem(ownerInfo.restaurantId, itemId, localStorage)
    if (result.success) {
      alert('âœ… ÄÃ£ xÃ³a mÃ³n!')
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  }
}

const handleToggleAvailability = (itemId) => {
  const result = toggleMenuItemAvailability(ownerInfo.restaurantId, itemId, localStorage)
  if (result.success) {
    loadDashboardData()
  }
}

// VOUCHER HANDLERS
const handleAddVoucher = () => {
  setEditingVoucher(null)
  setIsVoucherModalOpen(true)
}

const handleEditVoucher = (voucher) => {
  setEditingVoucher(voucher)
  setIsVoucherModalOpen(true)
}

const handleSaveVoucher = (voucherData) => {
  if (editingVoucher) {
    const result = updateVoucher(ownerInfo.restaurantId, editingVoucher.id, voucherData, localStorage)
    if (result.success) {
      alert('âœ… Cáº­p nháº­t voucher thÃ nh cÃ´ng!')
      setIsVoucherModalOpen(false)
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  } else {
    const result = createVoucher(ownerInfo.restaurantId, voucherData, localStorage)
    if (result.success) {
      alert('âœ… Táº¡o voucher thÃ nh cÃ´ng!')
      setIsVoucherModalOpen(false)
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  }
}

const handleDeleteVoucher = (voucherId, code) => {
  if (window.confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a voucher "${code}"?`)) {
    const result = deleteVoucher(ownerInfo.restaurantId, voucherId, localStorage)
    if (result.success) {
      alert('âœ… ÄÃ£ xÃ³a voucher!')
      loadDashboardData()
    } else {
      alert('âŒ Lá»—i: ' + result.error)
    }
  }
}

const handleToggleVoucher = (voucherId, currentStatus) => {
  const result = updateVoucher(ownerInfo.restaurantId, voucherId, { isActive: !currentStatus }, localStorage)
  if (result.success) {
    loadDashboardData()
  }
}

// Filter orders
const filteredOrders = orders.filter(order => {
  const matchSearch = !searchTerm ||
    order.id?.toString().includes(searchTerm) ||
    order.customerName?.toLowerCase().includes(searchTerm.toLowerCase())

  const matchStatus = statusFilter === 'all' || order.status === statusFilter

  return matchSearch && matchStatus
})

const newOrdersCount = orders.filter(o => o.status === 'pending').length

if (!ownerInfo || !stats || !menuInfo) {
  return (
    <div className="loading-container">
      <div className="loading-spinner"></div>
      <p>Äang táº£i dá»¯ liá»‡u...</p>
    </div>
  )
}

return (
  <div className="dashboard-container">
    {/* HEADER */}
    <header className="dashboard-header">
      <div className="header-left">
        <h1>ğŸ½ï¸ {ownerInfo.restaurantName}</h1>
        {lastUpdate && (
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
            ğŸ“¡ Cáº­p nháº­t: {lastUpdate.toLocaleTimeString('vi-VN')}
          </div>
        )}
      </div>
      <div className="header-actions">
        {/* ğŸ”” Notification Bell */}
        <NotificationBell role="restaurant" />

        {/* Toggle Restaurant Status */}
        <button
          className={`status-toggle-btn ${restaurantStatus === 'active' ? 'active' : 'suspended'}`}
          onClick={handleToggleRestaurantStatus}
          title={restaurantStatus === 'active' ? 'Click Ä‘á»ƒ táº¡m ngÆ°ng' : 'Click Ä‘á»ƒ kÃ­ch hoáº¡t'}
        >
          {restaurantStatus === 'active' ? (
            <>âœ“ Äang hoáº¡t Ä‘á»™ng</>
          ) : (
            <>â¸ï¸ ÄÃ£ táº¡m ngÆ°ng</>
          )}
        </button>

        <button className="refresh-btn" onClick={loadDashboardData} title="LÃ m má»›i">
          ğŸ”„
        </button>
        <span className="owner-name">ğŸ‘¤ {ownerInfo.username}</span>
        <button onClick={handleLogout} className="logout-btn">
          ÄÄƒng xuáº¥t
        </button>
      </div>
    </header>

    {/* TABS */}
    <div className="dashboard-tabs">
      <button
        className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
        onClick={() => setActiveTab('overview')}
      >
        ğŸ“Š Tá»•ng quan
      </button>
      <button
        className={`tab-btn ${activeTab === 'orders' ? 'active' : ''}`}
        onClick={() => setActiveTab('orders')}
      >
        ğŸ“¦ ÄÆ¡n hÃ ng
        {newOrdersCount > 0 && (
          <span className="badge">{newOrdersCount}</span>
        )}
      </button>
      <button
        className={`tab-btn ${activeTab === 'menu' ? 'active' : ''}`}
        onClick={() => setActiveTab('menu')}
      >
        ğŸ“‹ Menu ({menuInfo.totalItems})
      </button>
      <button
        className={`tab-btn ${activeTab === 'vouchers' ? 'active' : ''}`}
        onClick={() => setActiveTab('vouchers')}
      >
        ğŸŸï¸ Voucher ({vouchers.length})
      </button>
    </div>

    <div className="dashboard-content">
      {/* TAB 1: Tá»”NG QUAN */}
      {activeTab === 'overview' && (
        <>
          <div className="overview-grid">
            <div className="overview-left">
              <h2>Thá»‘ng kÃª hÃ´m nay</h2>
              <div className="stats-grid">
                <div className="stat-card">
                  <div className="stat-icon">ğŸ“¦</div>
                  <h3>ÄÆ¡n hÃ ng hÃ´m nay</h3>
                  <p className="stat-number">{stats.todayOrders}</p>
                  <span className="stat-label">Tá»•ng: {stats.totalOrders} Ä‘Æ¡n</span>
                </div>

                {/* DOANH THU HÃ”M NAY - CHI TIáº¾T */}
                <div className="stat-card revenue-card">
                  <div className="stat-icon">ğŸ’°</div>
                  <h3>Doanh thu hÃ´m nay</h3>
                  <p className="stat-number">{stats.todayRevenue.total.toLocaleString()} Ä‘</p>

                  <div className="revenue-breakdown">
                    <div className="breakdown-item">
                      <span className="breakdown-label">
                        <span className="icon">ğŸª</span> NhÃ  hÃ ng ({stats.todayRevenue.percentages.restaurant}%)
                      </span>
                      <span className="breakdown-value restaurant">{stats.todayRevenue.restaurant.toLocaleString()} Ä‘</span>
                    </div>

                    <div className="breakdown-item">
                      <span className="breakdown-label">
                        <span className="icon">ğŸ“±</span> App ({stats.todayRevenue.percentages.app}%)
                      </span>
                      <span className="breakdown-value app">{stats.todayRevenue.app.toLocaleString()} Ä‘</span>
                    </div>
                  </div>

                  <span className="stat-label">
                    Tá»•ng táº¥t cáº£: {stats.totalRevenue.total.toLocaleString()} Ä‘
                  </span>
                </div>

                <div className="stat-card">
                  <div className="stat-icon">ğŸ”</div>
                  <h3>MÃ³n Äƒn</h3>
                  <p className="stat-number">{menuInfo.totalItems}</p>
                  <span className="stat-label">
                    Cá»‘ Ä‘á»‹nh: {menuInfo.staticMenu.length} | TÃ¹y chá»‰nh: {menuInfo.customMenu.length}
                  </span>
                </div>

                <div className="stat-card">
                  <div className="stat-icon">â³</div>
                  <h3>ÄÆ¡n chá» xá»­ lÃ½</h3>
                  <p className="stat-number">{stats.pendingOrders}</p>
                  <span className="stat-label">
                    Äang giao: {stats.processingOrders} | HoÃ n thÃ nh: {stats.deliveredOrders}
                  </span>
                </div>
              </div>

              <OrderChart data={chartData} type="line" />
            </div>

            <div className="overview-right">
              <NotificationSystem restaurantId={ownerInfo.restaurantId} />
            </div>
          </div>
        </>
      )}

      {/* TAB 2: ÄÆ N HÃ€NG */}
      {activeTab === 'orders' && (
        <>
          <div className="orders-header">
            <h2>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h2>
            <button onClick={exportToCSV} className="export-btn">
              ğŸ“Š Xuáº¥t Excel
            </button>
          </div>

          <OrderFilters
            searchTerm={searchTerm}
            onSearchChange={setSearchTerm}
            statusFilter={statusFilter}
            onStatusChange={setStatusFilter}
            dateFilter={dateFilter}
            onDateChange={setDateFilter}
            orderCount={filteredOrders.length}
          />

          {filteredOrders.length === 0 ? (
            <div className="empty-state">
              <p className="empty-icon">ğŸ“¦</p>
              <h3>KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng</h3>
              <p>Thá»­ thay Ä‘á»•i bá»™ lá»c hoáº·c tÃ¬m kiáº¿m khÃ¡c</p>
            </div>
          ) : (
            <div className="orders-list">
              {filteredOrders.map((order, index) => (
                <div key={order.id || index} className="order-card">
                  <div className="order-header">
                    <span className="order-id">ÄÆ¡n #{order.id || index + 1}</span>
                    <span className={`order-status status-${order.status || 'pending'}`}>
                      {order.status === 'delivered' ? 'âœ… ÄÃ£ giao' :
                        order.status === 'processing' ? 'ğŸšš Äang giao' :
                          'â³ Chá» xÃ¡c nháº­n'}
                    </span>
                  </div>

                  <div className="order-info">
                    <p>ğŸ“… {new Date(order.date || order.createdAt).toLocaleString('vi-VN')}</p>
                    <p>ğŸ“ {order.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰'}</p>
                    <p>ğŸ‘¤ {order.customerName || 'KhÃ¡ch hÃ ng'}</p>
                  </div>

                  <div className="order-items">
                    {order.items?.map((item, idx) => (
                      <div key={idx} className="order-item">
                        <span>{item.name}</span>
                        <span>x{item.quantity}</span>
                        <span>{(item.price * item.quantity).toLocaleString()} Ä‘</span>
                      </div>
                    ))}
                  </div>

                  <div className="order-footer">
                    <span className="order-total">
                      Tá»•ng: <strong>{order.totalPrice?.toLocaleString()} Ä‘</strong>
                    </span>
                    <div className="order-actions">
                      {order.status === 'pending' && (
                        <button
                          className="action-btn confirm"
                          onClick={() => handleUpdateOrderStatus(order.id, 'processing')}
                        >
                          âœ“ XÃ¡c nháº­n
                        </button>
                      )}
                      {order.status === 'processing' && (
                        <button
                          className="action-btn deliver"
                          onClick={() => handleUpdateOrderStatus(order.id, 'delivered')}
                        >
                          âœ“ ÄÃ£ giao
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </>
      )}

      {/* TAB 3: MENU */}
      {activeTab === 'menu' && (
        <>
          <div className="menu-header">
            <h2>Quáº£n lÃ½ Menu ({menuInfo.totalItems} mÃ³n)</h2>
            <button className="add-btn" onClick={handleAddMenuItem}>
              â• ThÃªm mÃ³n má»›i
            </button>
          </div>

          <div className="menu-sections">
            {menuInfo.customMenu.length > 0 && (
              <>
                <h3>MÃ³n tÃ¹y chá»‰nh ({menuInfo.customMenu.length})</h3>
                <div className="menu-grid">
                  {menuInfo.customMenu.map(item => (
                    <div key={item.id} className="menu-item-card custom">
                      <div className="menu-item-header">
                        <h4>{item.name}</h4>
                        <label className="toggle-switch">
                          <input
                            type="checkbox"
                            checked={item.isAvailable !== false}
                            onChange={() => handleToggleAvailability(item.id)}
                          />
                          <span className="toggle-slider"></span>
                        </label>
                      </div>
                      <p className="price">{item.price.toLocaleString()} Ä‘</p>
                      <p className="description">{item.description}</p>
                      <div className="item-actions">
                        <button
                          className="edit-btn"
                          onClick={() => handleEditMenuItem(item)}
                        >
                          âœï¸ Sá»­a
                        </button>
                        <button
                          className="delete-btn"
                          onClick={() => handleDeleteMenuItem(item.id, item.name)}
                        >
                          ğŸ—‘ï¸ XÃ³a
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            <h3>MÃ³n cÃ³ sáºµn ({menuInfo.staticMenu.length})</h3>
            <div className="menu-grid">
              {menuInfo.staticMenu.map(item => (
                <div key={item.id} className="menu-item-card">
                  <h4>{item.title}</h4>
                  <p className="price">{item.price.toLocaleString()} Ä‘</p>
                  <p className="description">{item.description}</p>
                  <span className="static-badge">MÃ³n há»‡ thá»‘ng</span>
                </div>
              ))}
            </div>
          </div>
        </>
      )}

      {/* TAB 4: VOUCHERS */}
      {activeTab === 'vouchers' && (
        <>
          <div className="vouchers-header">
            <h2>Quáº£n lÃ½ Voucher ({vouchers.length})</h2>
            <button className="add-btn" onClick={handleAddVoucher}>
              ğŸŸï¸ Táº¡o voucher má»›i
            </button>
          </div>

          {vouchers.length === 0 ? (
            <div className="empty-state">
              <p className="empty-icon">ğŸŸï¸</p>
              <h3>ChÆ°a cÃ³ voucher nÃ o</h3>
              <p>Táº¡o voucher Ä‘á»ƒ thu hÃºt khÃ¡ch hÃ ng</p>
              <button className="add-btn-empty" onClick={handleAddVoucher}>
                â• Táº¡o voucher Ä‘áº§u tiÃªn
              </button>
            </div>
          ) : (
            <div className="vouchers-grid">
              {vouchers.map(voucher => (
                <div key={voucher.id} className={`voucher-card ${voucher.isActive ? 'active' : 'inactive'}`}>
                  <div className="voucher-header">
                    <div className="voucher-code">{voucher.code}</div>
                    <label className="toggle-switch">
                      <input
                        type="checkbox"
                        checked={voucher.isActive}
                        onChange={() => handleToggleVoucher(voucher.id, voucher.isActive)}
                      />
                      <span className="toggle-slider"></span>
                    </label>
                  </div>

                  <div className="voucher-body">
                    <div className="voucher-discount">
                      Giáº£m {voucher.discountValue}
                      {voucher.discountType === 'percentage' ? '%' : 'Ä‘'}
                      {voucher.maxDiscount && voucher.discountType === 'percentage' &&
                        ` (tá»‘i Ä‘a ${voucher.maxDiscount.toLocaleString()}Ä‘)`
                      }
                    </div>

                    {voucher.minOrderValue > 0 && (
                      <div className="voucher-min">
                        ÄÆ¡n tá»‘i thiá»ƒu: {voucher.minOrderValue.toLocaleString()}Ä‘
                      </div>
                    )}

                    <div className="voucher-expiry">
                      HSD: {new Date(voucher.expiryDate).toLocaleDateString('vi-VN')}
                      {new Date(voucher.expiryDate) < new Date() && (
                        <span className="expired-tag">Háº¿t háº¡n</span>
                      )}
                    </div>

                    {voucher.description && (
                      <p className="voucher-desc">{voucher.description}</p>
                    )}
                  </div>

                  <div className="voucher-actions">
                    <button
                      className="edit-btn"
                      onClick={() => handleEditVoucher(voucher)}
                    >
                      âœï¸ Sá»­a
                    </button>
                    <button
                      className="delete-btn"
                      onClick={() => handleDeleteVoucher(voucher.id, voucher.code)}
                    >
                      ğŸ—‘ï¸ XÃ³a
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </>
      )}
    </div>

    {/* MODALS */}
    <MenuItemModal
      isOpen={isMenuModalOpen}
      onClose={() => setIsMenuModalOpen(false)}
      onSave={handleSaveMenuItem}
      editItem={editingMenuItem}
    />

    <VoucherModal
      isOpen={isVoucherModalOpen}
      onClose={() => setIsVoucherModalOpen(false)}
      onSave={handleSaveVoucher}
      editVoucher={editingVoucher}
    />
  </div>
)
}